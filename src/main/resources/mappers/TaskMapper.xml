<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.todo_api.mapper.TaskMapper">

    <!-- UserとTaskの関連をマッピングするための設計図 -->
    <resultMap id="taskWithAssigneesResultMap" type="com.example.todo_api.entity.Task">
        <id property="id" column="task_id"/>
        <result property="title" column="task_title"/>
        <result property="completed" column="task_completed"/>
        <result property="version" column="task_version"/>
        <!-- 1対多の関係をマッピング -->
        <collection property="assignees" ofType="com.example.todo_api.entity.User">
            <!-- ★★★ Userエンティティのプロパティ名を "userId" に修正 ★★★ -->
            <id property="userId" column="user_id"/>
            <result property="name" column="user_name"/>
        </collection>
    </resultMap>

    <!-- 1件取得 -->
    <select id="findById" resultMap="taskWithAssigneesResultMap">
        SELECT
            t.id AS task_id,
            t.title AS task_title,
            t.completed AS task_completed,
            t.version AS task_version,
            u.id AS user_id,
            u.name AS user_name
        FROM
            tasks t
        LEFT JOIN
            task_assignees ta ON t.id = ta.task_id
        LEFT JOIN
            users u ON ta.user_id = u.id
        WHERE
            t.id = #{id}
    </select>

    <!-- 全件取得 -->
    <select id="findAll" resultMap="taskWithAssigneesResultMap">
        SELECT
            t.id AS task_id,
            t.title AS task_title,
            t.completed AS task_completed,
            t.version AS task_version,
            u.id AS user_id,
            u.name AS user_name
        FROM
            tasks t
        LEFT JOIN
            task_assignees ta ON t.id = ta.task_id
        LEFT JOIN
            users u ON ta.user_id = u.id
    </select>

    <!-- 更新 -->
    <update id="update" parameterType="com.example.todo_api.entity.Task">
        UPDATE tasks 
        SET 
            title = #{title}, 
            completed = #{completed},
            version = version + 1
        WHERE 
            id = #{id}
        AND
            version = #{version}
    </update>
    
    <!-- 削除 -->
    <delete id="deleteById" parameterType="com.example.todo_api.entity.Task">
        DELETE FROM
            tasks
        WHERE 
            id = #{id}
        AND
            version = #{version}
    </delete>

</mapper>